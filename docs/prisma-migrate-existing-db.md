# Initialiser Prisma Migrate sur une base de données existante

## Problème

Quand vous avez une base de données existante avec des tables et des données, et que vous voulez commencer à utiliser Prisma Migrate, vous rencontrez souvent cette erreur :

```
Drift detected: Your database schema is not in sync with your migration history.
We need to reset the "public" schema...
All data will be lost.
```

## Pourquoi cette erreur ?

- Prisma Migrate s'attend à ce que toute la structure de votre base soit créée via des migrations
- Quand il n'y a aucune migration, Prisma considère que l'état "attendu" de la DB est vide
- Votre DB contient des tables → Prisma voit ça comme un "drift" par rapport à l'état vide attendu
- Il propose alors de reset la DB, ce qui supprimerait toutes vos données

## Solution : Créer une migration baseline

Cette procédure permet de créer une migration "baseline" qui représente l'état actuel de votre base, sans perdre de données.

### Étapes

```bash
# 1. Créer une migration baseline à partir de l'état actuel de la DB
bunx prisma migrate diff --from-empty --to-schema-datamodel prisma/schema.prisma --script > init.sql

# 2. Créer la structure de migration manuellement
mkdir -p prisma/migrations/001_init
mv init.sql prisma/migrations/001_init/migration.sql

# 3. Créer le fichier migration_lock.toml
echo '# Please do not edit this file manually
provider = "postgresql"' > prisma/migrations/migration_lock.toml

# 4. Marquer la migration comme déjà appliquée
bunx prisma migrate resolve --applied "001_init"
```

### Ce que fait chaque commande

1. **`prisma migrate diff`** : Génère le SQL nécessaire pour passer d'une base vide à votre schéma actuel
2. **`mkdir + mv`** : Crée la structure de fichiers que Prisma attend pour les migrations
3. **`echo migration_lock.toml`** : Crée le fichier qui indique le type de base de données utilisé
4. **`prisma migrate resolve`** : Dit à Prisma que cette migration est déjà appliquée dans la base

### Résultat

Après ces étapes :
- ✅ Vos données sont intactes
- ✅ Prisma a un historique de migrations propre
- ✅ Vous pouvez créer de nouvelles migrations normalement avec `prisma migrate dev`

### Vérification

```bash
# Vérifier que tout fonctionne
bunx prisma migrate status

# Tester en créant une nouvelle migration
bunx prisma migrate dev --name "test-migration"
```

## Cas d'usage

Cette procédure est utile quand :
- On migre d'une autre ORM vers Prisma
- On change de type de base de données (SQLite → PostgreSQL)
- On a créé votre schéma manuellement ou avec `prisma db push`
- on veut commencer à utiliser les migrations sur un projet existant

## Alternative plus simple (si applicable)

Si vous n'avez pas de données importantes à conserver :

```bash
# Reset complet (⚠️ SUPPRIME TOUTES LES DONNÉES)
bunx prisma migrate reset --force

# Puis créer les migrations normalement
bunx prisma migrate dev --name "init"
```